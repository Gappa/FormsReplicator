name: CI

on:
    push:
    schedule:
        -   cron: '0 8 * * 1' # At 08:00 on Monday

jobs:
    parallel-lint:
        name: 🔎 Parallel lint
        strategy:
            fail-fast: false
            matrix:
                php:
                    - "8.1"
                    - "8.2"
                    - "8.3"
                    - "8.4"
                dependencies:
                    - "lowest"
                    - "highest"
                operating-system: [ 'ubuntu-24.04' ]
        runs-on: ${{ matrix.operating-system }}
        steps:
            -   name: ⬇️ Checkout repo
                uses: actions/checkout@v4

            -   name: 🐘 Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    coverage: none

            -   name: 📥 Install dependencies
                uses: ramsey/composer-install@v3
                with:
                    dependency-versions: "${{ matrix.dependencies }}"

            -   name: 🔎 Parallel lint
                run: php ./vendor/bin/parallel-lint -e php,phpt --exclude ./.git --exclude ./vendor .

    phpstan:
        name: 🟩️️ PHPStan
        strategy:
            fail-fast: false
            matrix:
                php:
                    - "8.1"
                    - "8.2"
                    - "8.3"
                    - "8.4"
                dependencies:
                    - "lowest"
                    - "highest"
                operating-system: [ 'ubuntu-24.04' ]
        runs-on: ${{ matrix.operating-system }}
        steps:
            -   name: ⬇️ Checkout repo
                uses: actions/checkout@v4

            -   name: 🐘 Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    coverage: none

            -   name: 📥 Install dependencies
                uses: ramsey/composer-install@v3
                with:
                    dependency-versions: "${{ matrix.dependencies }}"

            -   name: 🟩️️ PHPStan
                run: php ./vendor/bin/phpstan --ansi

    ecs:
        name: ✏️️ ECS
        strategy:
            fail-fast: false
            matrix:
                php:
                    - "8.1"
                    - "8.2"
                    - "8.3"
                    - "8.4"
                dependencies:
                    - "lowest"
                    - "highest"
                operating-system: [ 'ubuntu-24.04' ]
        runs-on: ${{ matrix.operating-system }}
        steps:
            -   name: ⬇️ Checkout repo
                uses: actions/checkout@v4

            -   name: 🐘 Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    coverage: none

            -   name: 📥 Install dependencies
                uses: ramsey/composer-install@v3
                with:
                    dependency-versions: "${{ matrix.dependencies }}"

            -   name: ✏️️ ECS
                run: php ./vendor/bin/ecs

    rector:
        name: 🛠️ Rector
        strategy:
            fail-fast: false
            matrix:
                php:
                    - "8.1"
                    - "8.2"
                    - "8.3"
                    - "8.4"
                dependencies:
                    - "lowest"
                    - "highest"
                operating-system: [ 'ubuntu-24.04' ]
        runs-on: ${{ matrix.operating-system }}
        steps:
            -   name: ⬇️ Checkout repo
                uses: actions/checkout@v4

            -   name: 🐘 Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    coverage: none

            -   name: 📥 Install dependencies
                uses: ramsey/composer-install@v3
                with:
                    dependency-versions: "${{ matrix.dependencies }}"

            -   name: 🛠️ Rector
                run: php ./vendor/bin/rector process --dry-run --ansi

    tester:
        name: 🧮 Tester
        strategy:
            fail-fast: false
            matrix:
                php:
                    - "8.1"
                    - "8.2"
                    - "8.3"
                    - "8.4"
                dependencies:
                    - "lowest"
                    - "highest"
                operating-system: [ 'ubuntu-24.04' ]
        runs-on: ${{ matrix.operating-system }}
        steps:
            -   name: ⬇️ Checkout repo
                uses: actions/checkout@v4

            -   name: 🐘 Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    coverage: xdebug

            -   name: 📥 Install dependencies
                uses: ramsey/composer-install@v3
                with:
                    dependency-versions: "${{ matrix.dependencies }}"

            -   name: 🧮 Tester
                run: php ./vendor/bin/tester -s -p php --colors 1 -C ./tests/Replicator
